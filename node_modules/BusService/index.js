var BusMQ = require('busmq');

var bus;

module.exports = function(redisHost, redisPort, redisPassword){
	// initialize internal bus object
	bus = createBus();

	// exports
	this.consume = consume;
	this.produce = produce;
}

function createBus(redisHost, redisPort, redisPassword){
	// detect redis host & port
	var REDIS_HOST = redisHost || 'localhost';
	var REDIS_PORT = redisPort || 6379;
	var REDIS_PASSWORD = redisPassword || '';

	// append '@' if passowrd supplied
	REDIS_PASSWORD = REDIS_PASSWORD ? REDIS_PASSWORD + '@' : REDIS_PASSWORD;

	var redisUrl = 'redis://' + REDIS_PASSWORD + REDIS_HOST + ':' + REDIS_PORT;
	bus = BusMQ.create({redis: [redisUrl]});
	console.log('Bus was successfuly created.');
	return bus;
}

// connecting to bus, attaching to appropriate queue and perform 
// user callback upon incoming messages
function consume(queueName, callback){
	bus.on('online', function() {
	  var q = bus.queue(queueName);
	  q.on('attached', function() {
	    console.log('Attached consumer to queue ' + queueName + '.');
	  });
	  q.on('message', function(message, id) {
	  	// call the callback
	  	callback(message);
	  });
	  q.attach();
	  // the 'message' event will be fired when a message is retrieved
	  q.consume(); 
	});

	// connect the redis instances
	//TODO moshe add a comment
	//bus.connect();
}

// used because some of the consumers are also the producers of another jobs
// connecting to the bus, attaching to a queue and pushing a job
function produce(queueName, message){
	bus.on('online', function() {
	  var q = bus.queue(queueName);
	  q.on('attached', function() {
	    console.log('Attached producer to queue ' + queueName + '.');
	  });
	  q.attach();
	  q.push(message);
	});
	bus.connect();
}